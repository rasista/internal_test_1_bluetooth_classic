# RTT Event Decoder Usage Guide

## Overview
The `rtt_event_decoder.py` script decodes binary RTT (Real-Time Transfer) log data generated by the Bluetooth Classic HSS (Host Stack Service) events. It parses events like inquiry_complete, page_complete, FHS packets, and data packets (DH1, DH3, DH5) using the new generic format from `log_lpw_hss_packet`.

## Prerequisites
- Python 3.x
- Binary log files generated by the Bluetooth Classic system

## Recent Updates (Latest Version)

### New Generic Data Packet Format
The decoder now supports the updated C code format where `log_lpw_hss_packet` sends the entire `hss_event` with metadata:

**Format:** `[event_type][event_status][br_edr_mode][event_size+3][entire_hss_event][timestamp]`

- **Event Type**: `0x07` (BTC_DATA_PKT_RECEIVED)
- **Event Status**: `0x06` (BTC_DATA_PKT_RECEIVED_SUCCESS)
- **BR/EDR Mode**: Current mode (0x00 = BASIC_RATE, 0x01 = ENHANCED_RATE)
- **Event Size + 3**: Total size of hss_event data plus 3 metadata bytes
- **Entire HSS Event**: Complete packet data including packet header, HEC, and payload
- **Timestamp**: 4-byte timestamp in little-endian format

### Enhanced Raw Data Display
- **Formatted Raw Data**: Each byte is separated by spaces for easy analysis
- **Data Length**: Shows the total byte count for each event
- **Validation Support**: Raw bytes can be compared with expected data structure

## Basic Usage

### Command Format
```bash
python3 rtt_event_decoder.py <log_file>
```

### Examples
```bash
# Decode central logs
python3 rtt_event_decoder.py ../../logs/host_central_logs.txt

# Decode peripheral logs  
python3 rtt_event_decoder.py ../../logs/host_peri_logs.txt

# Decode any binary log file
python3 rtt_event_decoder.py my_custom_log.bin
```

## Console Output

### Successful Decoding
```bash
$ python3 rtt_event_decoder.py ../../logs/host_central_logs.txt
Decoding completed successfully!
Input file: ../../logs/host_central_logs.txt
Output file: ../../logs/host_central_logs_decoded.txt
Total events decoded: 9
```

### File Not Found
```bash
$ python3 rtt_event_decoder.py nonexistent_file.txt
Error: File 'nonexistent_file.txt' not found
```

### Usage Help
```bash
$ python3 rtt_event_decoder.py
Usage: python rtt_event_decoder.py <log_file>
Example: python rtt_event_decoder.py ../../logs/host_central_logs.txt
Output will be saved to: <log_file>_decoded.txt
```

## Output File Format

The decoder creates a `_decoded.txt` file with detailed event information including formatted raw data. Here are examples of different event types:

### 1. HSS Events (page_complete, inquiry_complete, etc.)
```
============================================================
Event #1: page_complete
============================================================
Raw Data: 02 02 00 e3 c2 32 03
Data Length: 7 bytes
Event Type: 02 (page_complete)
Event Status: 02 (CONNECTION_CREATED)
Timestamp: 53658339
connection_info_idx: 0
```

### 2. Data Packets (DH1, DH3, DH5) - New Generic Format
```
============================================================
Event #4: data_packet_received
============================================================
Raw Data: 07 06 01 1b a5 3f 0f 8e 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 22 2d 96 cd 32 03
Data Length: 32 bytes
Event Type: 07 (data_packet_received)
Event Status: 06 (DATA_PKT_RECEIVED_SUCCESS)
Timestamp: 53661078
packet_type: 2DH1
br_edr_mode: 1 (ENHANCED_RATE)
```

### 3. FHS Packets (Frequency Hop Synchronization)
```
============================================================
Event #1: data_packet_received
============================================================
Raw Data: 07 06 00 1a 90 b2 2c fb b9 a4 d3 46 88 cc 04 44 55 66 00 00 00 e0 86 ab 06 41 fe b2 a0 20 03
Data Length: 31 bytes
Event Type: 07 (data_packet_received)
Event Status: 06 (DATA_PKT_RECEIVED_SUCCESS)
Timestamp: 52469938
packet_type: FHS
br_edr_mode: 0 (BASIC_RATE)
bd_address: 11:22:33:44:55:66
lap_address: 11:22:33
lt_address: 0
```

### 4. Page Scan Complete (with BD Address)
```
============================================================
Event #2: page_scan_complete
============================================================
Raw Data: 03 05 00 11 22 33 44 00 72 31 a1 de 04
Data Length: 13 bytes
Event Type: 03 (page_scan_complete)
Event Status: 05 (CONNECTION_COMPLETED)
Timestamp: 58465499
connection_info_idx: 0
remote_bd_address: 11:22:33:44:00:72
```

## Event Types and Status Codes

### HSS Event Types
- `0x00`: inquiry_complete
- `0x01`: inquiry_scan_complete
- `0x02`: page_complete
- `0x03`: page_scan_complete
- `0x04`: acl_complete
- `0x05`: role_switch_complete
- `0x06`: tx_pkt_ack_received
- `0x07`: data_packet_received (unified format for all data packets)

### Event Status Codes
- `0x00`: ACTIVITY_DURATION_COMPLETED
- `0x01`: INQUIRY_EIR_TIMEOUT
- `0x02`: CONNECTION_CREATED
- `0x03`: CONNECTION_RESP_TOUT
- `0x04`: NEW_CONNECTION_TOUT
- `0x05`: CONNECTION_COMPLETED
- `0x06`: DATA_PKT_RECEIVED_SUCCESS

### BR/EDR Mode
- `0x00`: BASIC_RATE
- `0x01`: ENHANCED_RATE

### Packet Type Detection
The decoder now uses the `GET_RX_PKT_HEADER_TYPE` macro from the C code to extract packet types:

```python
# Packet header extraction macros (from btc_ut_hss_event_callbacks.h)
PKT_HEADER_PKT_TYPE_MASK = 0xF   # 4-bit TYPE
PKT_HEADER_PKT_TYPE_POS = 3      # bits 3-6

def GET_RX_PKT_HEADER_TYPE(buf):
    """Extract packet type from buffer using the same macro as C code"""
    return ((buf >> PKT_HEADER_PKT_TYPE_POS) & PKT_HEADER_PKT_TYPE_MASK)
```

### Packet Type Names
Based on BR/EDR mode and extracted packet type:
- **FHS**: `FHS` (packet type 0x02)
- **DH1**: `DH1` (BASIC_RATE) or `2DH1` (ENHANCED_RATE)
- **DH3**: `DH3` (BASIC_RATE) or `3DH3` (ENHANCED_RATE)
- **DH5**: `DH5` (BASIC_RATE) or `3DH5` (ENHANCED_RATE)

## File Naming Convention

The decoder automatically creates output files with the following naming:
- Input: `host_central_logs.txt` → Output: `host_central_logs_decoded.txt`
- Input: `my_log.bin` → Output: `my_log_decoded.txt`
- Input: `data.log` → Output: `data_decoded.txt`

## Decoding Summary

Each decoded file ends with a summary section:
```
============================================================
DECODING SUMMARY
============================================================
Total Events: 9
Decoding Errors: 0
Success Rate: 100.0%
```

## Troubleshooting

### Common Issues

1. **"File not found" error**
   - Ensure the log file exists in the specified path
   - Check file permissions

2. **"Incomplete event data" warning**
   - The log file may be corrupted or truncated
   - Check if the file was completely written

3. **"Unknown" events**
   - New event types not yet defined in the decoder
   - Check if the C code is generating new event types

4. **Decoding errors**
   - Binary format mismatch between C code and Python decoder
   - Verify both C and Python code are using the same event format

### Debug Information

The decoder provides detailed information for debugging:
- **Formatted Raw Data**: Each byte separated by spaces for easy analysis
- **Data Length**: Total byte count for each event
- **Event Size Calculations**: Based on event_size + 3 for data packets
- **Timestamp Values**: 4-byte timestamps in little-endian format
- **Payload Parsing Details**: Complete packet data extraction

## Advanced Usage

### Batch Processing
```bash
# Process multiple log files
for file in ../../logs/*.txt; do
    python3 rtt_event_decoder.py "$file"
done
```

### Data Validation
Use the formatted raw data to validate your RTT output:
```bash
# Compare raw bytes with expected structure
# Example: Check if event type 0x07 has correct format
grep "Raw Data: 07 06" ../../logs/host_central_logs_decoded.txt
```

### Custom Output Format
The script can be modified to output in different formats (JSON, CSV, etc.) by changing the `write_event_summary` function.

## Integration with Development Workflow

1. **Build and run** your Bluetooth Classic system
2. **Collect RTT logs** during operation
3. **Run the decoder** on the log files
4. **Analyze the decoded output** for debugging and verification
5. **Validate raw data** against expected packet structures

## Example Workflow

```bash
# 1. Build the system
make clean && make

# 2. Run the system and collect logs
# (System generates host_central_logs.txt and host_peri_logs.txt)

# 3. Decode the logs
python3 rtt_event_decoder.py ../../logs/host_central_logs.txt
python3 rtt_event_decoder.py ../../logs/host_peri_logs.txt

# 4. Analyze the results with raw data validation
cat ../../logs/host_central_logs_decoded.txt
cat ../../logs/host_peri_logs_decoded.txt

# 5. Validate specific packet types
grep "packet_type: FHS" ../../logs/host_central_logs_decoded.txt
grep "br_edr_mode: 1" ../../logs/host_peri_logs_decoded.txt
```

## Technical Details

### C Code Integration
The decoder is designed to work with the updated `log_lpw_hss_packet` function:

```c
// New generic format in log_lpw_hss_packet
linear_buffer[buffer_index++] = BTC_DATA_PKT_RECEIVED;        // 0x07
linear_buffer[buffer_index++] = BTC_DATA_PKT_RECEIVED_SUCCESS; // 0x06
linear_buffer[buffer_index++] = br_edr_mode;                  // br_edr_mode
linear_buffer[buffer_index++] = event_size + 3;               // event_size + 3
// Then dump entire hss_event
for(int i = 0 ; i < event_size ; i++) {
  linear_buffer[buffer_index++] = hss_event[i];
}
// Then timestamp (4 bytes)
```

### Packet Type Extraction
Uses the same macro logic as the C code:
```c
#define GET_RX_PKT_HEADER_TYPE(buf) ((buf >> PKT_HEADER_PKT_TYPE_POS) & PKT_HEADER_PKT_TYPE_MASK)
```

## Notes

- The decoder supports both `.txt` and `.bin` input files
- Timestamps are in PROTIMER ticks (shifted right by 3)
- FHS packet parsing uses the same logic as the C code `parse_fhs_pkt` function
- Data packets now show complete information including raw data for validation
- All events include formatted raw data with byte spacing for easy analysis
- The new generic format eliminates the need for separate event types for different packet types
- Raw data validation enables debugging of packet structure and content
